CREATE DATABASE healthcare_db;
SHOW TABLES;

--INTEGRATION OF AWS_S3 TO SNOWFLAKE 
CREATE OR REPLACE STORAGE INTEGRATION aws_s3_integrate
TYPE = EXTERNAL_STAGE
ENABLED = TRUE
STORAGE_PROVIDER = 'S3'
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::930245986673:role/integrate_s3_snowflake'
STORAGE_ALLOWED_LOCATIONS = ('s3://ballesh321');

SHOW INTEGRATIONS;
DESC INTEGRATION aws_s3_integrate;

--CREATING File formats are created to specify how data files are structured during loading or exporting operations

CREATE OR REPLACE FILE FORMAT integrate_file_format
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1;

--CREATE STAGE TO LOAD THE DATA OF S3
CREATE OR REPLACE STAGE LOAD_S3_SNOWFLAKE
FILE_FORMAT = 'integrate_file_format'
STORAGE_INTEGRATION = aws_s3_integrate
URL = 's3://ballesh321';

LIST @LOAD_S3_SNOWFLAKE;

CREATE OR REPLACE TABLE HEALTH_CARE_CSV (
Name VARCHAR(200),
Age INT, 
Gender VARCHAR(200), 
Diagnosis VARCHAR(200),
Treatment VARCHAR(200),
Billing DECIMAL (10,2));

SHOW TABLES;
DROP TABLE HEALTH_CARE_CSV;
SELECT * FROM HEALTH_CARE_CSV;
TRUNCATE TABLE HEALTH_CARE_CSV;

CREATE MASKING POLICY Diagnosis_mask AS (val VARCHAR) RETURNS VARCHAR ->
CASE
WHEN CURRENT_ROLE() IN ('MASKED') THEN val
ELSE CONCAT('*********') END;
 
ALTER TABLE HEALTH_CARE_CSV MODIFY COLUMN Diagnosis UNSET MASKING POLICY Diagnosis_mask;

COPY INTO HEALTH_CARE_CSV (Name, Age, Gender, Diagnosis, Treatment, Billing)
FROM @LOAD_S3_SNOWFLAKE/hospital.csv
FILE_FORMAT = (TYPE= CSV) ;

SHOW TABLES;

CREATE MASKING POLICY bil_mask AS (val DECIMAL ) RETURNS DECIMAL ->
CASE WHEN CURRENT_ROLE() IN ('ACCESS') THEN val 
ELSE '0000'
END;

ALTER TABLE HEALTH_CARE_CSV MODIFY COLUMN BILLING UNSET MASKING POLICY ;

LIST @LOAD_S3_SNOWFLAKE;
REMOVE @LOAD_S3_SNOWFLAKE/health.csv;

TRUNCATE TABLE HEALTH_CARE_CSV ;
SHOW STAGES;
LIST @LOAD_S3_SNOWFLAKE;

SELECT SYSTEM$GET_AWS_SNS_IAM_POLICY( 'arn:aws:sns:ap-south-1:930245986673:SNOWPIPESNS' );

CREATE OR REPLACE PIPE  snow_pipe_integrate
   AUTO_INGEST = TRUE 
   AWS_SNS_TOPIC = 'arn:aws:sns:ap-south-1:930245986673:SNOWPIPESNS' 
AS
  COPY INTO HEALTH_CARE_CSV (Name, Age, Gender, Diagnosis, Treatment, Billing)
FROM @LOAD_S3_SNOWFLAKE/hospital.csv
FILE_FORMAT = (TYPE= CSV) ; 

SHOW PIPES;
SELECT * FROM HEALTH_CARE_CSV;
SHOW TABLES;

SELECT TOP 5 * FROM STG_VIEWERSHIP;
DESC TABLE STG_VIEWERSHIP;

CREATE MASKING POLICY ASDAS AS (val VARCHAR) RETURNS VARCHAR ->
CASE 
WHEN CURRENT_ROLE() IN ('ADMIN') THEN val 
ELSE CONCAT('XXX-XX-', SUBSTR(val, -5,-6)) END ;

ALTER TABLE STG_VIEWERSHIP MODIFY COLUMN USER_ID SET MASKING POLICY ASDAS;

CREATE OR REPLACE MASKING POLICY masking AS (val NUMBER) RETURNS NUMBER ->
       CASE WHEN CURRENT_ROLE() IN ('HEALTH_MANAGER') THEN val
       ELSE ('00')
       END;
ALTER TABLE STG_VIEWERSHIP MODIFY COLUMN VIEWERS SET MASKING POLICY masking;

SELECT TOP 10 * FROM STG_VIEWERSHIP;

CREATE OR REPLACE MASKING POLICY D_masking AS (val DATE) RETURNS DATE ->
       CASE WHEN CURRENT_ROLE() IN ('HEALTH_MANAGER') THEN val
       ELSE ('2000-01-01')
       END;

       ALTER TABLE STG_VIEWERSHIP MODIFY COLUMN VIEW_DATE SET MASKING POLICY D_masking;

SHOW ROLES;
SHOW DATABASES;

REVOKE OWNERSHIP ON DATABASE FINANCE_DB FROM ROLE FULL_ACCESS;
